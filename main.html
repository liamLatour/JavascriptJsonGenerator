<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="info.css">
    <meta charset="utf-8" />
    <title>Config.json</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

    <ul class="form-style-1">
        <!--General-->
            <h2>General</h2>
        <li>
            <label title="Définit le nom du noeud, 15 caractères maximum" id="name">Nom du noeud <span>*</span></label>
            <input id="nom" type="text"/>
        </li>
        <li>
            <label title="Définit la quantité de messages retourné par le noeud
                   (cocher = plus de messages)" id="name">Verbose</label>
            <input id="verbose" type="checkbox" name"gender" value="1"> 
        </li>
        <li>
            <label title="Active ou non les LEDs internes" id="name">LED</label>
            <input id="led" type="checkbox" name"gender" value="1">        
        </li>
        <li>
            <label title="Dispositif pour empêcher le plantage du noeud en le remettant à zéro" id="name">Watchdog</label>
            <input id="watchdog" type="checkbox" name"gender" value="1" checked="checked">        
        </li>
        <li>
            <label title="Active ou non la sortie de débogage du noeud" id="name">Debug en Série</label>
            <input id="debug" type="checkbox" name"gender" value="1">        
        </li>

        <!--Network-->
        <h2>Réseau</h2>
        <li>
            <label title="Indique le type de réseau utilisé" id="name">Type de réseau <span>*</span></label>
            <input id="typenet" type="text" value="LoRaWAN"/>
        </li>
        <li>
            <label title="Identifiant unique du noeud" id="name">DevEUI <span>*</span></label>
            <input id="deveui" type="text"/>
        </li>
        <li>
            <label title="Identifiant d'application" id="name">AppEUI <span>*</span></label>
            <input id="appeui" type="text"/>
        </li>
        <li>
            <label title="Clef d'authentification auprès de l'application" id="name">AppKey <span>*</span></label>
            <input id="appkey" type="text"/>
        </li>
        <li>
            <label title="Temps entre deux envoies" id="name">Intervalle d'émission <span>*</span></label>
            <input id="periodsec" type="range" min="3600" max="36000" value="1200" oninput="updateTextInput(this);"/>
            <label id="value"></label>
        </li>
        <li>
            <label title="Ajuste automatiquement le datarate" id="name">Utiliser un DataRate adaptatif</label>
            <input id="adaptData" type="checkbox" name"gender" value="1" onchange="updateDatarate(this);">        
        </li>
        <li id="data">
            <label title="Indique le datarate à utiliser" id="name">DataRate</label>
            <input id="datarate" type="range" min="0" max="5" value="5" oninput="updateDatarateSlider(this);"/>
            <label id="value"></label>
        </li>

        <!--Sensors-->
        <h2>Capteurs</h2>
        <div id="sensors">

        </div>
        <li>
            <div align="center">
                <button type="button" onclick="addSens()">+</button>
                <button type="button" onclick="supSens()">-</button>
            </div>
        </li>

        <!--Interupts-->
        <h2>Interruptions</h2>
        <div id="interuptions">

        </div>
        <li>
            <div align="center">
                <button type="button" onclick="addInt()">+</button>
               <button type="button" onclick="supInt()">-</button>
            </div>
        </li>

        <!--Time-->
        <h2>Synchronisation du temps</h2>
        <li>
            <label title="Utilise la synchronisation GPS" id="name">Synchronisation GPS</label>
            <input id="syncGPS" type="checkbox" name"gender" value="1" checked="checked" onchange="updateGPS(this);">        
        </li>
        <div id="GPS">
            <li>
                <label title="Définit le temps d'attente maximale pour obtenir une accroche GPS" id="name">Timeout en Seconde</label>
                <input id="timeout" type="range" min="60" max="240" value="120" oninput="updateTextInput(this);"/>
                <label id="value"></label>
            </li>
            <li>
                <label title="Définit la période de resynchronisation" id="name">Temps entre deux synchronisations</label>
                <input id="syncperiodsec" type="range" min="10" max="500" value="250" oninput="updateTextInput(this);"/>
                <label id="value"></label>
            </li>
        </div>
        <div id="manual">
            <li>
                <label title="Indiquer l'heure courante, de préférence dans le futur pour simplifier la tâche
                Mettre une date non valide pour conserver la dernière date valide" id="name">Manual UTC</label>
                <input id="settime" type="time" step="1"/>
                <input id="datePicker" type="date"/>                
            </li>
        </div>

        <div align="center">
            <a id="download" href="#">Générer le lien</a>
            <div id="container">

            </div>
        </div>
    </ul>

    <script>
        //fonction pour inclure le html
        function includeHTML() {
            var z, i, elmnt, file, xhttp;
            z = document.getElementsByTagName("*");
            for (i = 0; i < z.length; i++) {
                elmnt = z[i];
                file = elmnt.getAttribute("w3-include-html");
                if (file) {
                xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4) {
                    if (this.status == 200) {elmnt.innerHTML = this.responseText;}
                    if (this.status == 404) {elmnt.innerHTML = "Page not found.";}
                    elmnt.removeAttribute("w3-include-html");
                    includeHTML();
                    }
                }      
                xhttp.open("GET", file, true);
                xhttp.send();
                return;
                }
            }
            };

        //ajoute un sensor
        function addSens(){
            $('<div w3-include-html="sensor.html" id="sensor" class="sens"></div>').appendTo("#sensors");    
            includeHTML();
        }

        //ajoute une interruption
        function addInt(){
            $('<div w3-include-html="interruption.html" id="int" class="interupt"></div>').appendTo("#interuptions");
            includeHTML();
        }

        //enlever un sensor
        function supSens(){
            $("#sensors #sensor").last().remove();
        }

        //enlever une interuption
        function supInt(){
            $("#interuptions #int").last().remove();
        }

        //Rempli la date au bon fuseau horaire
        Date.prototype.toDateInputValue = (function() {
            var local = new Date(this);
            local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
            return local.toJSON().slice(0,10);
        });

        document.getElementById('datePicker').value = new Date().toDateInputValue();

        //Pour la visualisation des sliders
        function updateTextInput(el) {
            var brut = parseInt(el.value);
            var heure = (brut-(brut%3600))/3600;
            brut = brut - heure*3600;
            var minutes = (brut-(brut%60))/60;
            var sec = brut - minutes*60;

            var display = "";

            if(heure > 0){
                display += heure+'h ';
            }
            if(minutes > 0){
                display += minutes+'m ';
            }

            display += sec+'s';

            $(el).next().html(display);
        }

        //Pour la visualisation du datarate
        function updateDatarateSlider(el) {
            $(el).next().html(el.value);
        }

        //Pour le debounce
        function updateTextInputMS(el){
            $(el).next().html(el.value + 'ms');
        }

        //Pour la partie GPS
        function updateGPS(el) {
            if($(el).is(":checked")){
                document.getElementById("manual").style.display = 'none';
                document.getElementById("GPS").style.display = 'inline';
            }
            else{
                document.getElementById("manual").style.display = 'inline';
                document.getElementById("GPS").style.display = 'none';
            }
        }

        //Pour la partie Datarate
        function updateDatarate(el) {
            if($(el).is(":checked")){
                document.getElementById("data").style.display = 'none';
            }
            else{
                document.getElementById("data").style.display = 'block';
            }
        }

        //Pour la partie Alarm des sensors
        function updateSens(el) {
            if($(el).is(":checked")){
                $(el).parent().next("#alarm").css('display', 'block');
            }
            else{
                $(el).parent().next("#alarm").css('display', 'none');
            }
        }

        //Genère le fichier Json dans le 'div' précedemment vide
        window.onload = function() {
            var a = document.getElementById("download");
            a.onclick = function() {
                //variables pour les champs fixent
                var name = document.getElementById('nom').value;
                var verbose = $("#verbose").is(":checked");
                var led = $("#led").is(":checked");
                var watchdog = $("#watchdog").is(":checked");
                var debugSerial = $("#debug").is(":checked");

                var type = document.getElementById('typenet').value;
                var devEUI = document.getElementById('deveui').value;
                var appEUI = document.getElementById('appeui').value;
                var appKey = document.getElementById('appkey').value;
                var periodSec = parseInt(document.getElementById('periodsec').value);
                var dataRate = parseInt(document.getElementById('datarate').value);
                var useAdaptativeDataRate = $("adaptData").is(":checked");

                var syncGPS = $("syncGPS").is(":checked");
                var syncGPSTimeoutSec = parseInt(document.getElementById('timeout').value);
                var syncPeriodSec = parseInt(document.getElementById('syncperiodsec').value);
                //récupère la date en entié puis la sépare
                var date = document.getElementById('datePicker').value.split('-');
                var year = parseInt(date[0]);
                var month = parseInt(date[1]);
                var day = parseInt(date[2]);
                //récupère le moment exact puis le sépare
                var moment = document.getElementById('settime').value.split(':');
                var hours = parseInt(moment[0]);
                var minutes = parseInt(moment[1]);
                var seconds = parseInt(moment[2]);

                var obj = {"name": name, 
                            "verbose": verbose,
                            "led": led,
                            "watchdog": watchdog,
                            "debugSerial": debugSerial,
                            "network": {
                                "type": type,
                                "devEUI": devEUI,
                                "appEUI": appEUI,
                                "appKey": appKey,
                                "periodSec": periodSec,
                                "dataRate": dataRate,
                                "useAdaptativeDataRate": useAdaptativeDataRate
                            },
                            "time": {
                                "syncGPS": syncGPS,
                                "syncGPSTimeoutSec": syncGPSTimeoutSec,
                                "syncPeriodSec": syncPeriodSec,
                                "manualUTC": {
                                    "year": year,
                                    "month": month,
                                    "day": day,
                                    "hours": hours,
                                    "minutes": minutes,
                                    "seconds": seconds
                                }
                            }
                        };

                //Remplis la liste d'interuption
                var inters = document.getElementsByClassName("interupt");
                if(inters.length>0){
                    obj["interruptions"] = [];
                    for(var i=0; i<inters.length; i++){
                        var intname = $(inters[i]).find('#intname').val();
                        var intdeb = parseInt($(inters[i]).find('#intdeb').val());

                        var intnames = intname.split(" ");

                        if(intnames.length < 2){
                            obj["interruptions"].push({"name": intname, "debounceMs": intdeb});
                        }
                        else{
                            var tempobj = [];
                            for(var j=0; j<intnames.length; j++){
                                tempobj.push(intnames[j]);
                            }
                            obj["interruptions"].push({"names": tempobj, "debounceMs": intdeb});
                        }
                    }
                }

                //Remplis les sensors
                var sens = document.getElementsByClassName("sens");
                if(sens.length>0){
                    obj["sensors"] = [];
                    for(var i=0; i<sens.length; i++){
                        var sensname = $(sens[i]).find('#sensname').val();
                        var senstype = $(sens[i]).find('#senstype').val();
                        var sensperiod = parseInt($(sens[i]).find('#sensperiod').val());
                        var sensint = $(sens[i]).find('#sensint').val();
                        var senssend = $(sens[i]).find('#senssend').is(":checked");
                        var sensalarm = $(sens[i]).find('#sensalarm').is(":checked"); 
                        
                        var tempobj = {"name": sensname,
                                        "type": senstype,
                                        "periodSec": sensperiod,
                                        "sendOnInterrupt": senssend
                                        };
                        
                        if(sensalarm){
                            var alarmset = $(sens[i]).find('#alarmset').is(":checked");
                            var alarmcleared = $(sens[i]).find('#alarmcleared').is(":checked");
                            var thresholdset = parseInt($(sens[i]).find('#thresholdset').val());
                            var thresholdclear = parseInt($(sens[i]).find('#thresholdclear').val());

                            tempobj["alarm"] = {"sendOnAlarmSet": alarmset,
                                                "sendOnAlarmCleared": alarmcleared,
                                                "thresholdSetMMPerMinute": thresholdset,
                                                "thresholdClearMMPerMinute": thresholdclear
                                                };
                        }

                        if(sensint.length > 0){
                            var sensints = sensint.split(" ");

                            if(sensints.length < 2){
                                tempobj["interruptChannel"] = sensint;
                            }
                            else{
                                var tempints = [];
                                for(var j=0; j<sensints.length; j++){
                                    tempints.push(sensints[j]);
                                }
                                tempobj["interruptChannel"] = tempints;
                            }
                        }

                        obj["sensors"].push(tempobj);
                    }
                }

                var data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj));

                $("#generatedLink").remove();
                $('<a id="generatedLink" href="data:' + data + '" download="config.json">Télécharger JSON</a>').appendTo('#container');
                return false;
            }
        }
    </script>

</body>
</html> 